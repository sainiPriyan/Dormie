<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login | Roommate Finder</title>
<style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
    nav { background:#003366; display:flex; justify-content:space-between; padding:14px 20px; align-items:center; }
    nav a { color:white; text-decoration:none; margin:0 10px; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .login-box { background:white; padding:30px; border-radius:10px; width:320px; margin:100px auto; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    h2 { text-align:center; color:#003366; }
    input { width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px; }
    button { width:100%; padding:12px; background:#003366; color:white; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#0055a4; }
    /* Modal styles */
    .modal { display:none; position:fixed; z-index:10; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.3);}
    .modal-content { background:white; margin:10% auto; padding:30px; border-radius:10px; width:340px; box-shadow:0 4px 10px rgba(0,0,0,0.2);}
    .close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;}
    .close:hover { color:#003366;}
</style>
</head>
<body>

<nav>
  <div><a href="/">Roommate Finder</a></div>
  <div>
    <a href="/">Login</a>
    <a href="/profile">Profile</a>
    <a href="/home">Home</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="login-box">
  <h2>Login to Continue</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p style="text-align:center;">No account? <a href="#" onclick="showSignup()">Sign Up</a></p>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeSignup()">&times;</span>
    <h2 style="margin-top:0;">Sign Up</h2>
    <input type="text" id="newUsername" placeholder="Username">
    <input type="email" id="newEmail" placeholder="Email">
    <input type="password" id="newPassword" placeholder="Password">
    <button onclick="sendOTP()">Send OTP</button>
    <div id="otpSection" style="display:none;">
      <input type="text" id="otpInput" placeholder="Enter OTP">
      <button onclick="verifyOTP()">Verify & Register</button>
    </div>
  </div>
</div>

<script>
let generatedOTP = null;
let signupData = {};

// If already logged in, redirect automatically
window.addEventListener("load", () => {
  const existing = localStorage.getItem("username");
  if (existing) {
    window.location.href = "/home";
  }
});

function showSignup() {
  document.getElementById('signupModal').style.display = 'block';
  document.getElementById('otpSection').style.display = 'none';
  document.getElementById('newUsername').value = '';
  document.getElementById('newEmail').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('otpInput').value = '';
}

function closeSignup() {
  document.getElementById('signupModal').style.display = 'none';
}

window.onclick = function(event) {
  const modal = document.getElementById('signupModal');
  if (event.target === modal) closeSignup();
}

// Simulated OTP (you can replace with real email sending later)
function sendOTP() {
  const email = document.getElementById('newEmail').value.trim();
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value.trim();

  if (!username || !email || !password) {
    alert("Please fill all signup fields before sending OTP.");
    return;
  }

  signupData = { username, email, password };
  generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
  alert("Your OTP (demo): " + generatedOTP);
  document.getElementById('otpSection').style.display = 'block';
}

async function verifyOTP() {
  const otp = document.getElementById('otpInput').value.trim();
  if (!otp) return alert("Please enter OTP.");
  if (otp !== generatedOTP) return alert("Invalid OTP. Please try again.");

  try {
    const res = await fetch('/api/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(signupData)
    });
    const data = await res.json();
    if (res.ok) {
      alert("Signup successful! You can now login.");
      closeSignup();
    } else {
      alert("Signup failed: " + data.message);
    }
  } catch (error) {
    alert("Signup error: " + error.message);
  }
}

async function login() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if (!username || !password) {
    alert("Please enter username and password.");
    return;
  }

  try {
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (res.ok && data.success) {
      // Store username globally
      localStorage.setItem("username", username);
      localStorage.setItem("userProfile", JSON.stringify({ name: username }));

      alert("Login successful!");
      window.location.href = "/profile";
    } else {
      alert("Invalid username or password.");
    }
  } catch (error) {
    alert("Login error: " + error.message);
  }
}

// Logout feature added
function logout() {
  if (confirm("Are you sure you want to log out?")) {
    localStorage.removeItem("username");
    localStorage.removeItem("userProfile");
    window.location.href = "/";
  }
}
</script>

</body>
</html>
